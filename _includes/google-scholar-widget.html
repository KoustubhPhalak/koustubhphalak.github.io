<div class="google-scholar-widget" id="scholar-widget-{{ include.scholar_id }}">
    <h3>ðŸ“š {{ include.title | default: "Google Scholar Profile" }}</h3>
    <div class="scholar-stats">
      <div class="stat">
        <span class="number scholar-citations">Loading...</span>
        <span class="label">Citations</span>
      </div>
      <div class="stat">
        <span class="number scholar-h-index">Loading...</span>
        <span class="label">h-index</span>
      </div>
      <div class="stat">
        <span class="number scholar-i10-index">Loading...</span>
        <span class="label">i10-index</span>
      </div>
    </div>
    <a href="https://scholar.google.com/citations?user={{ include.scholar_id }}" 
       target="_blank" class="scholar-link">
      View Full Profile â†’
    </a>
    <p class="last-updated">
      <small>Last updated: <span class="update-time">Loading...</span></small>
    </p>
  </div>
  
  <script>
    (function() {
      // Replace with your actual Scholar ID
      const scholarId = 'B36kyxIAAAAJ'; 
      
      console.log('Attempting to fetch Scholar data for ID:', scholarId);
      
      async function fetchScholarData() {
        // Try multiple CORS proxies
        const proxies = [
          'https://api.allorigins.win/get?url=',
          'https://cors-anywhere.herokuapp.com/',
          'https://api.codetabs.com/v1/proxy?quest=',
          'https://thingproxy.freeboard.io/fetch/'
        ];
        
        const targetUrl = `https://scholar.google.com/citations?user=${scholarId}&hl=en`;
        
        for (let i = 0; i < proxies.length; i++) {
          try {
            console.log(`Trying proxy ${i + 1}:`, proxies[i]);
            
            let response;
            if (i === 0) {
              // allorigins format
              response = await fetch(proxies[i] + encodeURIComponent(targetUrl));
              const data = await response.json();
              parseScholarData(data.contents);
              return; // Success, exit
            } else {
              // Direct proxy format
              response = await fetch(proxies[i] + targetUrl);
              const html = await response.text();
              parseScholarData(html);
              return; // Success, exit
            }
          } catch (error) {
            console.error(`Proxy ${i + 1} failed:`, error);
          }
        }
        
        // If all proxies fail, show error
        showError();
      }
      
      function parseScholarData(html) {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          console.log('Parsing Scholar data...');
          
          // Method 1: Try the statistics table
          const statsTable = doc.querySelector('#gsc_rsb_st');
          if (statsTable) {
            const rows = statsTable.querySelectorAll('tr');
            if (rows.length >= 4) {
              const citations = rows[1].querySelector('td:nth-child(2)')?.textContent?.trim();
              const hIndex = rows[2].querySelector('td:nth-child(2)')?.textContent?.trim();
              const i10Index = rows[3].querySelector('td:nth-child(2)')?.textContent?.trim();
              
              if (citations && hIndex && i10Index) {
                updateWidget(citations, hIndex, i10Index);
                return;
              }
            }
          }
          
          // Method 2: Try alternative selectors
          const statsElements = doc.querySelectorAll('.gsc_rsb_std');
          if (statsElements.length >= 5) {
            updateWidget(
              statsElements[0].textContent.trim(),
              statsElements[2].textContent.trim(),
              statsElements[4].textContent.trim()
            );
            return;
          }
          
          throw new Error('Could not find citation data in page');
          
        } catch (error) {
          console.error('Error parsing Scholar data:', error);
          showError();
        }
      }
      
      function updateWidget(citations, hIndex, i10Index) {
        console.log('Updating widget with:', {citations, hIndex, i10Index});
        
        document.querySelector('.scholar-citations').textContent = citations;
        document.querySelector('.scholar-h-index').textContent = hIndex;
        document.querySelector('.scholar-i10-index').textContent = i10Index;
        document.querySelector('.update-time').textContent = new Date().toLocaleDateString();
      }
      
      function showError() {
        document.querySelector('.scholar-citations').textContent = 'Error';
        document.querySelector('.scholar-h-index').textContent = 'Error';
        document.querySelector('.scholar-i10-index').textContent = 'Error';
        document.querySelector('.update-time').textContent = 'Failed to load';
      }
      
      // Add timeout to prevent infinite loading
      setTimeout(() => {
        if (document.querySelector('.scholar-citations').textContent === 'Loading...') {
          console.log('Timeout reached, showing error');
          showError();
        }
      }, 15000); // 15 second timeout
      
      // Start fetching when page loads
      fetchScholarData();
    })();
    </script>
  
  <style>
  .google-scholar-widget {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .google-scholar-widget h3 {
    margin-top: 0;
    color: #333;
    text-align: center;
  }
  
  .scholar-stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    gap: 10px;
  }
  
  .stat {
    text-align: center;
    flex: 1;
  }
  
  .number {
    display: block;
    font-size: 28px;
    font-weight: bold;
    color: #4285f4;
    margin-bottom: 5px;
  }
  
  .label {
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .scholar-link {
    display: block;
    text-align: center;
    margin-top: 15px;
    padding: 10px 20px;
    background: #4285f4;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    transition: background 0.3s;
  }
  
  .scholar-link:hover {
    background: #3367d6;
    color: white;
  }
  
  .last-updated {
    text-align: center;
    margin-top: 10px;
    margin-bottom: 0;
    color: #888;
  }
  
  @media (max-width: 600px) {
    .scholar-stats {
      flex-direction: column;
      gap: 15px;
    }
  }
  </style>