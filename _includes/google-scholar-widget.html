<div class="google-scholar-widget" id="scholar-widget-{{ include.scholar_id }}">
    <h3>ðŸ“š {{ include.title | default: "Google Scholar Profile" }}</h3>
    <div class="scholar-stats">
      <div class="stat">
        <span class="number scholar-citations">Loading...</span>
        <span class="label">Citations</span>
      </div>
      <div class="stat">
        <span class="number scholar-h-index">Loading...</span>
        <span class="label">h-index</span>
      </div>
      <div class="stat">
        <span class="number scholar-i10-index">Loading...</span>
        <span class="label">i10-index</span>
      </div>
    </div>
    <a href="https://scholar.google.com/citations?user={{ include.scholar_id }}" 
       target="_blank" class="scholar-link">
      View Full Profile â†’
    </a>
    <p class="last-updated">
      <small>Last updated: <span class="update-time">Loading...</span></small>
    </p>
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting Scholar fetch...');
    
    const scholarId = '{{ include.scholar_id }}';
    const widgetId = 'scholar-widget-{{ include.scholar_id }}';
    const widget = document.getElementById(widgetId);
    
    console.log('Scholar ID:', scholarId);
    console.log('Widget element:', widget);
    
    if (!widget) {
      console.error('Widget element not found with ID:', widgetId);
      return;
    }
    
    async function fetchScholarData() {
      try {
        console.log('Fetching data for Scholar ID:', scholarId);
        
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const targetUrl = `https://scholar.google.com/citations?user=${scholarId}&hl=en`;
        
        console.log('Target URL:', targetUrl);
        
        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data keys:', Object.keys(data));
        
        if (!data.contents) {
          throw new Error('No contents in response');
        }
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        
        console.log('Parsed document');
        
        // Method 1: Try the statistics table
        const statsTable = doc.querySelector('#gsc_rsb_st');
        console.log('Stats table found:', !!statsTable);
        
        if (statsTable) {
          const rows = statsTable.querySelectorAll('tr');
          console.log('Table rows found:', rows.length);
          
          if (rows.length >= 4) {
            const citationsCell = rows[1].querySelector('td:nth-child(2)');
            const hIndexCell = rows[2].querySelector('td:nth-child(2)');
            const i10IndexCell = rows[3].querySelector('td:nth-child(2)');
            
            if (citationsCell && hIndexCell && i10IndexCell) {
              const citations = citationsCell.textContent.trim();
              const hIndex = hIndexCell.textContent.trim();
              const i10Index = i10IndexCell.textContent.trim();
              
              console.log('Extracted data:', {citations, hIndex, i10Index});
              updateWidget(citations, hIndex, i10Index);
              return;
            }
          }
        }
        
        // Method 2: Try alternative selectors
        const statsElements = doc.querySelectorAll('.gsc_rsb_std');
        console.log('Stats elements found:', statsElements.length);
        
        if (statsElements.length >= 5) {
          const citations = statsElements[0].textContent.trim();
          const hIndex = statsElements[2].textContent.trim();
          const i10Index = statsElements[4].textContent.trim();
          
          console.log('Alternative extraction:', {citations, hIndex, i10Index});
          updateWidget(citations, hIndex, i10Index);
          return;
        }
        
        throw new Error('Could not find citation data in page');
        
      } catch (error) {
        console.error('Error fetching Scholar data:', error);
        showError();
      }
    }
    
    function updateWidget(citations, hIndex, i10Index) {
      console.log('Updating widget with:', {citations, hIndex, i10Index});
      
      const citationsElement = widget.querySelector('.scholar-citations');
      const hIndexElement = widget.querySelector('.scholar-h-index');
      const i10IndexElement = widget.querySelector('.scholar-i10-index');
      const updateTimeElement = widget.querySelector('.update-time');
      
      if (citationsElement) citationsElement.textContent = citations;
      if (hIndexElement) hIndexElement.textContent = hIndex;
      if (i10IndexElement) i10IndexElement.textContent = i10Index;
      if (updateTimeElement) updateTimeElement.textContent = new Date().toLocaleDateString();
      
      console.log('Widget updated successfully');
    }
    
    function showError() {
      console.log('Showing error in widget');
      
      const citationsElement = widget.querySelector('.scholar-citations');
      const hIndexElement = widget.querySelector('.scholar-h-index');
      const i10IndexElement = widget.querySelector('.scholar-i10-index');
      const updateTimeElement = widget.querySelector('.update-time');
      
      if (citationsElement) citationsElement.textContent = 'Error';
      if (hIndexElement) hIndexElement.textContent = 'Error';
      if (i10IndexElement) i10IndexElement.textContent = 'Error';
      if (updateTimeElement) updateTimeElement.textContent = 'Failed to load';
    }
    
    // Add timeout
    setTimeout(() => {
      const citationsElement = widget.querySelector('.scholar-citations');
      if (citationsElement && citationsElement.textContent === 'Loading...') {
        console.log('Timeout reached, showing error');
        showError();
      }
    }, 15000);
    
    // Start fetching
    fetchScholarData();
  });
  </script>
  
  <style>
  .google-scholar-widget {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .google-scholar-widget h3 {
    margin-top: 0;
    color: #333;
    text-align: center;
  }
  
  .scholar-stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    gap: 10px;
  }
  
  .stat {
    text-align: center;
    flex: 1;
  }
  
  .number {
    display: block;
    font-size: 28px;
    font-weight: bold;
    color: #4285f4;
    margin-bottom: 5px;
  }
  
  .label {
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .scholar-link {
    display: block;
    text-align: center;
    margin-top: 15px;
    padding: 10px 20px;
    background: #4285f4;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    transition: background 0.3s;
  }
  
  .scholar-link:hover {
    background: #3367d6;
    color: white;
  }
  
  .last-updated {
    text-align: center;
    margin-top: 10px;
    margin-bottom: 0;
    color: #888;
  }
  
  @media (max-width: 600px) {
    .scholar-stats {
      flex-direction: column;
      gap: 15px;
    }
  }
  </style>